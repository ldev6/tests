workflows:
  android-espresso-tests:
    name: Android Espresso Tests
    instance_type: mac_mini_m2 # Or another suitable instance type
    max_build_duration: 60 # Maximum build duration in minutes

    environment:
      android_signing:
        - testKeystores
      # Define any environment variables needed for your tests, e.g., API keys
      #vars:
      # EXAMPLE_API_KEY: Encrypted(...) # If using sensitive data

    triggering:
      # Define how builds are triggered, e.g., on push to a specific branch
      events:
        - push
      branch_patterns:
        - pattern: master
          include: true

    scripts:
      - name: Start emulator
        script: |
          emulator -avd emulator > /dev/null 2>&1 &

      - name: Set Android SDK location
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/local.properties"
      - name: Set up keystore
        script: |
          echo $testKeystores | base64 --decode > /tmp/keystore.keystore
          cat >> "$FCI_BUILD_DIR/key.properties" <<EOF

      - name: Run Espresso Tests
        script: |
          # This command executes your instrumented tests.
          # Ensure your test runner is configured in your build.gradle.
          cd android && ./gradlew connectedAndroidTest


    artifacts:
      # Define any artifacts to be collected, e.g., test reports
      - $CM_BUILD_DIR/android/app/build/reports/**/*.xml
      - $CM_BUILD_DIR/android/app/build/outputs/apk/androidTest/**/*.apk


    publishing:
      email:
        recipients:
          - laurence.de.villers.prog@gmail.com
        notify:
          success: true
          failure: false
